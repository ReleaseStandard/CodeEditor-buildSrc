ext['githubOwner'] = "ReleaseStandard"

def p(msg) {
	def debug = System.env.DEBUG
	if ( debug ) {
		println msg
	}
}

// deduce the remaining part from an entry object
def getRemainingPart(dir) {
  def remainPart = ""
  def projectDirectory = getProjectPath(dir)
  def rootProjectDirectory = rootDir.getPath()
  remainPart = projectDirectory.replace(rootProjectDirectory,"")
  remainPart = remainPart.replaceAll("/",":")
  return remainPart
}

def getProjectPath(obj) {
  if ( obj instanceof Project ) {
    return obj.projectDir.getPath()
  }
  if ( obj instanceof File ) {
      return obj.getPath()
  }
  return obj	
}

// produce project path from the moduleString
def moduleToProject(moduleString) {
  def trgGroup = "io.github.ReleaseStandard.CodeEditor"
  def parts = moduleString.split(":")
  def group = parts[0]
  def module = parts[1]
  def version = parts[2]
  def remainPart = group.replace(trgGroup,"")
  remainPart = remainPart.replace(".",":")
  def path = remainPart + ":${module}"
  return path
}

// BEGIN build.helper.gradle
//
// - implementation relative for projects
// - change remote to local when property buildFromLocal is set
//
def prefix(msg) {
	return "[TEST]" + msg
}
def info(msg) {
	project.logger.info(prefix(msg))
}
def debug(msg) {
	project.logger.debug(prefix(msg))
}

info("Script inclusion")

/**
 * Relative include for subprojects
 */
def resolveRelativePath(path) {
	def remainPart = getRemainingPart(project)
        String[] parts = remainPart.split(":")
        String finalPath = ""
        for(int a = 0; a < parts.length-1; a=a+1) {
        	if(parts[a].size() > 0 ) {
        		finalPath += ":" + parts[a]
        	}
        }
        finalPath += path
	def p = project.findProject(finalPath)
	if ( p != null ) {
        	if ( System.env.DEBUG ) { println "resolveRelativePath: finalPath=${finalPath},remainPart=${remainPart},path=${path}" }
        	return finalPath
        } else {
	        String alternativePath = remainPart + path
        	p = project.findProject(alternativePath)
        	if ( p != null ) {
	        	if ( System.env.DEBUG ) { println "resolveRelativePath: alternativePath=${alternativePath},path=${path}" }
	        	return alternativePath
        	}
        }
        println "[WARNING] : path resolution has failed"
        return null
}
// Use this to declare a production dependency on a local project
def implementationR(path) {

        def finalPath = resolveRelativePath(path)
        if ( System.env.DEBUG ) {
        	println "implementationR : finalPath=${finalPath}"
        }
        dependencies {
                universalEmbed project(path: finalPath)
        }
}
// Use this to declare a test dependecy on a local project
def testImplementationR(path) {
        def finalPath = resolveRelativePath(path)
        if ( System.env.DEBUG ) {
                println "testImplementationR : finalPath=${finalPath}"
        }
	dependencies {
		testImplementation project(path: finalPath)
	}
}
// Use this to declare a testFixtures on a local project
def testFixturesImplementationR(path) {
        def finalPath = resolveRelativePath(path)
        if ( System.env.DEBUG ) {
                println "testImplementationR : finalPath=${finalPath}"
        }
	dependencies {
		testFixturesImplementation project(path: finalPath)
	}
}


project.ext.set("implementationR",{ String path ->
        implementationR(path)
})

project.ext.set("testImplementationR",{ String path ->
        testImplementationR(path)
})

project.ext.set("testFixturesImplementationR",{ String path ->
        testFixturesImplementationR(path)
})



configurations {
	all {
		resolutionStrategy {
			dependencySubstitution.all { DependencySubstitution dependency ->
       if ( requested instanceof ProjectComponentSelector ) {
         info("This is a project dependencies")
       }
       else if ( requested instanceof ModuleComponentSelector ) {
					if ( rootProject.hasProperty('buildFromLocal') ) {

						// tweak remote dependencie resolution
						def trgGroup = "io.github.${githubOwner}.CodeEditor"
						if ( requested.group.matches("${trgGroup}.*") ) {
							def path = moduleToProject(requested.getDisplayName())
							def prj = rootProject.findProject(path)
							for(Task t : project.tasks) {
								if ( t.getName().equals("projects") || t.getName().equals("tasks") ) { continue }
								try {
									def rootAssemble = project.tasks.getByName(t.getName())
				                      			def childAssemble = prj.tasks.getByName(t.getName())
				                      			rootAssemble.dependsOn childAssemble
				                      			rootAssemble.mustRunAfter childAssemble
				                  		} catch(Exception e) {}
				                	}
							def explain = "Substitute ${requested.getDisplayName()} to ${prj} because we test"
							if ( System.env.DEBUG ) {
								println "DependencySubstitution: ${explain}"
							}
							dependency.useTarget(prj, "${explain}")
						}

					}
				}
			}
		}
	}
}

// END
