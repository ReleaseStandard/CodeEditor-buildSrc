//
// This class an universal way to embed dependencies into the final object
//

def universalEmbed(moduleSelector) {

    def resolvedSelector = moduleSelector
    if ( moduleSelector instanceof ProjectDependency ) {
        resolvedSelector = moduleSelector.getDependencyProject()
    }
    if ( moduleSelector instanceof String ) {
        resolvedSelector = rootProject.findProject(moduleToProject(moduleSelector))
    }
    if ( System.env.DEBUG ) {
        println "moduleSelector=${moduleSelector},resolvedSelector=${resolvedSelector}"
        for(Configuration c : resolvedSelector.configurations) {
            println "c=${c.getDisplayName()}"
        }
    }

    def selector = moduleSelector
    if ( rootProject.hasProperty('buildFromLocal') ) {
        selector = resolvedSelector
    }

    if ( project.plugins.hasPlugin("com.android.library") ) {
        apply plugin: 'com.kezong.fat-aar'
        fataar {
            transitive = true
        }
        if ( selector instanceof Project ) {
            selector.afterEvaluate {
                if ( !selector.plugins.hasPlugin("com.android.library")) {
                    if ( System.env.DEBUG ) {
                        println "${project} -> ${selector} don't have the plugin"
                        println "Due to a limitation of fat-aar we must correct that here"
                    }
                    project.dependencies.api selector
                }
            }
        } 
        project.dependencies.embed selector
    } else {
        project.dependencies.implementation selector
        /*
        if ( selector instanceof Project ) {
            project.sourceSets { 
                main {
                    java {
                        srcDirs "${selector.projectDir.getPath()}/src/"
                    }
                }
            }
        }
        */
    }
}



project.ext.set("universalEmbed",{ Object moduleSelector ->
        universalEmbed(moduleSelector)
})
